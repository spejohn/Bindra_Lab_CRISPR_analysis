# Input and Output Structure

This document details the expected input file formats, directory structures, and the structure of the output generated by the CRISPR Analysis Pipeline.

## Input Directory Structure

The pipeline supports multiple input directory structures, depending on your data type and analysis needs.

### File Requirements by Input Type

#### When Starting with FASTQ Files:
- **Library file is required** - Used to map sgRNA sequences to genes
- Contrast table - Defines the experimental comparisons
- Design matrix (optional) - For MAGeCK MLE analysis

#### When Starting with Count Files:
- **Library file is NOT required** - Mapping has already been completed
- The pipeline now explicitly checks for FASTQ files and only requires a library file when they are present
- Contrast table - Defines the experimental comparisons
- Design matrix (optional) - For MAGeCK MLE analysis

### Directory Structure Options

#### Option 1: FASTQ input

```
<input_dir>/
├── library.csv                  # CRISPR library file (REQUIRED for FASTQ analysis)
├── contrasts.csv                # Contrast definitions file (required)
├── design_matrix.txt            # Design matrix for MLE analysis (optional)
├── fastq/                       # Directory containing FASTQ files
│   ├── sample1_R1.fastq.gz      # Forward reads
│   ├── sample1_R2.fastq.gz      # Reverse reads (for paired-end data)
│   └── ...
```

#### Option 2: Count file input

```
<input_dir>/
├── contrasts.csv                # Contrast definitions file (required)
├── design_matrix.txt            # Design matrix for MLE analysis (optional)
├── experiment_counts.csv        # A SINGLE count file containing data for all samples
└── ...                          # NOT individual count files per sample
```

#### Option 3: Mixed input (both FASTQ and count files)

```
<input_dir>/
├── library.csv                  # CRISPR library file (REQUIRED only for FASTQ processing)
├── contrasts.csv                # Contrast definitions file (required)
├── design_matrix.txt            # Design matrix for MLE analysis (optional)
├── fastq/                       # Directory containing FASTQ files
│   ├── sample1_R1.fastq.gz
│   ├── sample1_R2.fastq.gz      # For paired-end data
│   └── ...
├── experiment_counts.csv        # A SINGLE count file containing data for all samples
└── ...                          # NOT individual count files per sample
```

### Required Input Files

1.  **Library File (library.csv)** - REQUIRED ONLY when processing FASTQ files:
    -   CSV format with columns for guide ID, gene, and sequence
    -   Used to map sgRNA sequences to their target genes
    -   Example:
        ```
        sgRNA,Gene,Sequence
        guide1,GENE1,ACGTACGTACGTACGTACGT
        guide2,GENE2,GTACGTACGTACGTACGTAC
        ```

2.  **Contrasts File (contrasts.csv)**:
    -   CSV format defining experimental contrasts
    -   Must contain columns for contrast name, control samples, and treatment samples
    -   Example:
        ```
        contrast,control,treatment
        drug_vs_control,control1|control2,drug1|drug2
        knockout_vs_wildtype,wt1|wt2,ko1|ko2
        ```
    -   **Note**: The pipeline expects tab-delimited text files for analysis. Use the [file conversion utility](FILE_CONVERSION.md) to convert CSV files to the required format.

3.  **Design Matrix (design_matrix.txt, optional)**:
    -   Tab-delimited file for MLE analysis
    -   First column must be 'Sample' followed by condition columns
    -   Example:
        ```
        Sample  Treatment  Replicate
        control1    0    1
        control2    0    2
        drug1    1    1
        drug2    1    2
        ```
    -   **Note**: The pipeline expects tab-delimited text files for analysis. Use the [file conversion utility](FILE_CONVERSION.md) to convert CSV files to the required format.

## Output Directory Structure

The pipeline creates a standardized directory structure with flattened organization for better clarity:

```
<output_dir>/
├── <experiment_name>/                      # Main experiment directory (or <experiment_name>_FASTQ/ or <experiment_name>_RC/)
│   ├── <experiment_name>.count             # Merged count file for the entire experiment
│   ├── <experiment_name>.log               # Log file for the entire experiment
│   ├── <experiment_name>_samples.txt       # Sample sheet for the experiment
│   │
│   ├── <contrast_name1>/                   # First contrast directory
│   │   ├── <contrast_name1>_RRA.gene_summary.txt     # MAGeCK RRA results
│   │   ├── <contrast_name1>_gMGK.csv                 # MAGeCK RRA results in CSV format
│   │   ├── <contrast_name1>_MLE.gene_summary.txt     # MAGeCK MLE results (when applicable)
│   │   ├── <contrast_name1>_gMLE.csv                 # MAGeCK MLE results in CSV format
│   │   ├── <contrast_name1>_DrugZ.txt                # DrugZ results
│   │   └── <contrast_name1>_gDZ.csv                  # DrugZ results in CSV format
│   │
│   ├── <contrast_name2>/                   # Second contrast directory
│   │   ├── <contrast_name2>_RRA.gene_summary.txt
│   │   ├── <contrast_name2>_gMGK.csv
│   │   └── ...
│   │
│   └── qc/                                 # Quality control plots and reports
```

When processing both FASTQ and count files, separate experiment directories are created:

```
<output_dir>/
├── <experiment_name>_FASTQ/                # Results from FASTQ file analysis
│   ├── <experiment_name>_FASTQ.count
│   ├── <experiment_name>_FASTQ.log
│   ├── <experiment_name>_FASTQ_samples.txt
│   └── ...
│
├── <experiment_name>_RC/                   # Results from read count file analysis
│   ├── <experiment_name>_RC.count
│   ├── <experiment_name>_RC.log
│   ├── <experiment_name>_RC_samples.txt
│   └── ...
```

### File Naming Conventions

-   **Log files**: `<experiment_name>.log`
-   **Sample sheets**: `<experiment_name>_samples.txt`
-   **Count files**: `<experiment_name>.count`
-   **RRA results**: `<contrast_name>_RRA.gene_summary.txt` and `<contrast_name>_gMGK.csv`
-   **MLE results**: `<contrast_name>_MLE.gene_summary.txt` and `<contrast_name>_gMLE.csv`
-   **DrugZ results**: `<contrast_name>_DrugZ.txt` and `<contrast_name>_gDZ.csv` 