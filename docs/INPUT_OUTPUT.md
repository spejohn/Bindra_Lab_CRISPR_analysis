# Input and Output Structure

This document details the expected input file formats, directory structures, and the structure of the output generated by the CRISPR Analysis Pipeline.

## Input Directory Structure

The pipeline supports multiple input directory structures, depending on your data type and analysis needs.

### File Requirements by Input Type

#### When Starting with FASTQ Files:
- **Library file is required** - Used to map sgRNA sequences to genes
- Contrast table - Defines the experimental comparisons
- Design matrix (optional) - For MAGeCK MLE analysis

#### When Starting with Count Files:
- **Library file is NOT required** - Mapping has already been completed
- The pipeline now explicitly checks for FASTQ files and only requires a library file when they are present
- Contrast table - Defines the experimental comparisons
- Design matrix (optional) - For MAGeCK MLE analysis

### Directory Structure Options

#### Option 1: FASTQ input

```
<input_dir>/
├── library.csv                  # CRISPR library file (REQUIRED for FASTQ analysis)
├── contrasts.csv                # Contrast definitions file (required)
├── design_matrix.txt            # Design matrix for MLE analysis (optional)
├── fastq/                       # Directory containing FASTQ files
│   ├── sample1_R1.fastq.gz      # Forward reads
│   ├── sample1_R2.fastq.gz      # Reverse reads (for paired-end data)
│   └── ...
```

#### Option 2: Count file input

```
<input_dir>/
├── contrasts.csv                # Contrast definitions file (required)
├── design_matrix.txt            # Design matrix for MLE analysis (optional)
├── experiment_counts.csv        # A SINGLE count file containing data for all samples
└── ...                          # NOT individual count files per sample
```

#### Option 3: Mixed input (both FASTQ and count files)

```
<input_dir>/
├── library.csv                  # CRISPR library file (REQUIRED only for FASTQ processing)
├── contrasts.csv                # Contrast definitions file (required)
├── design_matrix.txt            # Design matrix for MLE analysis (optional)
├── fastq/                       # Directory containing FASTQ files
│   ├── sample1_R1.fastq.gz
│   ├── sample1_R2.fastq.gz      # For paired-end data
│   └── ...
├── experiment_counts.csv        # A SINGLE count file containing data for all samples
└── ...                          # NOT individual count files per sample
```

### Required Input Files

1.  **Library File (library.csv)** - REQUIRED ONLY when processing FASTQ files:
    -   CSV format with columns for guide ID, gene, and sequence
    -   Used to map sgRNA sequences to their target genes
    -   Example:
        ```
        sgRNA,Gene,Sequence
        guide1,GENE1,ACGTACGTACGTACGTACGT
        guide2,GENE2,GTACGTACGTACGTACGTAC
        ```

2.  **Contrasts File (contrasts.csv)**:
    -   CSV format defining experimental contrasts
    -   Must contain columns for contrast name, control samples, and treatment samples
    -   Example:
        ```
        contrast,control,treatment
        drug_vs_control,control1|control2,drug1|drug2
        knockout_vs_wildtype,wt1|wt2,ko1|ko2
        ```
    -   **Note**: The pipeline expects tab-delimited text files for analysis. Use the [file conversion utility](FILE_CONVERSION.md) to convert CSV files to the required format.

3.  **Design Matrix (design_matrix.txt, optional)**:
    -   Tab-delimited file for MLE analysis
    -   First column must be 'Sample' followed by condition columns
    -   Example:
        ```
        Sample  Treatment  Replicate
        control1    0    1
        control2    0    2
        drug1    1    1
        drug2    1    2
        ```
    -   **Note**: The pipeline expects tab-delimited text files for analysis. Use the [file conversion utility](FILE_CONVERSION.md) to convert CSV files to the required format.

## Output Directory Structure

The pipeline creates a standardized directory structure:

```
<output_dir>/
├── <experiment_name>/                      # Main experiment directory
│   ├── <experiment_name>.count             # Merged count file for the experiment
│   ├── <experiment_name>_final.count.txt   # Final count table used for analysis
│   ├── contrasts.txt                     # Converted contrasts file used for analysis
│   ├── design_matrix.txt                 # Converted design matrix (if applicable)
│   ├── logs/                             # Directory for Snakemake rule logs
│   │   └── ...
│   ├── counts/                           # Intermediate counts per sample (if FASTQ input)
│   │   └── ...
│   │
│   ├── <contrast_name1>/                   # First contrast directory
│   │   ├── analysis_results/             # Native tool outputs
│   │   │   ├── <contrast_name1>_RRA.gene_summary.txt
│   │   │   ├── <contrast_name1>_RRA.sgrna_summary.txt
│   │   │   ├── <contrast_name1>_MLE.gene_summary.txt     # (If MLE run)
│   │   │   ├── <contrast_name1>_MLE.sgrna_summary.txt    # (If MLE run)
│   │   │   ├── <contrast_name1>_MLE.beta_coefficients.txt # (If MLE run)
│   │   │   └── <contrast_name1>_DrugZ.txt                # (If DrugZ run)
│   │   │   
│   │   ├── <contrast_name1>_gMGK.csv      # Converted RRA results (CSV)
│   │   ├── <contrast_name1>_gMLE.csv      # Converted MLE results (CSV, if run)
│   │   └── <contrast_name1>_gDZ.csv       # Converted DrugZ results (CSV, if run)
│   │
│   ├── <contrast_name2>/                   # Second contrast directory
│   │   └── ... (similar structure)
│   │
│   └── qc/                                 # Quality control plots and reports (if run)
│       ├── <sample1>_fastqc.html         # (If FASTQ input & QC run)
│       ├── <sample1>_fastqc.zip          # (If FASTQ input & QC run)
│       ├── ...
│       ├── <experiment_name>_sgrna_distribution.html
│       ├── <experiment_name>_gene_distribution.html
│       └── <experiment_name>_gini_index.html
```

When processing both FASTQ and count files (if supported in future), separate experiment directories might be created, e.g. `<experiment_name>_FASTQ/` and `<experiment_name>_RC/`. The current implementation focuses on a single output directory per input experiment directory.

### File Naming Conventions

-   **Log files**: `<output_dir>/<experiment_name>/logs/<rule_name>_{wildcards}.log`
-   **Final Count file**: `<output_dir>/<experiment_name>/{experiment_name}_final.count.txt`
-   **Converted Contrasts**: `<output_dir>/<experiment_name>/contrasts.txt`
-   **Converted Design Matrix**: `<output_dir>/<experiment_name>/design_matrix.txt`
-   **RRA Results (Native)**: `<output_dir>/<experiment_name>/<contrast_name>/analysis_results/<contrast_name>_RRA.gene_summary.txt`
-   **RRA Results (Converted)**: `<output_dir>/<experiment_name>/<contrast_name>/<contrast_name>_gMGK.csv`
-   **MLE Results (Native)**: `<output_dir>/<experiment_name>/<contrast_name>/analysis_results/<contrast_name>_MLE.gene_summary.txt` (if run)
-   **MLE Results (Converted)**: `<output_dir>/<experiment_name>/<contrast_name>/<contrast_name>_gMLE.csv` (if run)
-   **DrugZ Results (Native)**: `<output_dir>/<experiment_name>/<contrast_name>/analysis_results/<contrast_name>_DrugZ.txt` (if run)
-   **DrugZ Results (Converted)**: `<output_dir>/<experiment_name>/<contrast_name>/<contrast_name>_gDZ.csv` (if run)
-   **QC Plots**: `<output_dir>/<experiment_name>/qc/<plot_name>.html` (if run) 